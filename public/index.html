<!DOCTYPE html>
<html>
	<head>
		<title>Get24</title>
		
		<!-- Author: Cory Gross (cmg0030@tigermail.auburn.edu) -->
		<!-- Last Modified: January 26, 2013 -->
		<!-- Server source code at http://github.com/CoryG89/Get24 -->
		
		<!-- KineticJS canvas gfx library for ease of use, perf, layering -->
		<script type='text/ecmascript' src='js/kinetic-v4.3.1.min.js'></script>
		<!-- Local jQuery 1.9, for easy DOM manipulation/referencing, etc -->
		<script type='text/ecmascript' src='js/jquery-1.9.0.min.js'></script>
		<!-- jQuery Virtual Mouse Plugin for fast mobile event callbacks -->
		<script type='text/ecmascript' src='js/jquery.mobile.vmouse.js'></script>
		<!-- Client-side Socket.IO API, symbolic path handled by the server -->
		<script type='text/ecmascript' src='/socket.io/socket.io.js'></script>
		<!-- Twitter Bootstrap Javascript backend -->
		<script type='text/ecmascript' src='js/bootstrap.min.js'></script>
		<!-- Twitter Bootstrap CSS Framework -->
		<link type='text/css' rel='stylesheet' href='css/bootstrap.min.css' />
		<link type='text/css' rel='stylesheet' href='css/bootstrap-responsive.min.css' />
		<!-- Apply our own custom stylesheet last, to override anything else -->
		<link type='text/css' rel='stylesheet' href='css/custom.css' />
	</head>
<body>
	<!-- KineticJS wrapper && stage container -->
	<div class='container' id='wrapper'>	
		<div class='container' id='container'></div>
		<div class='input-append'>
		<input type='text' id='evalInput' disabled />
			<div class='btn btn-primary disabled' id='submitButton'>Submit 
			<i class='icon-chevron-right icon-white'></i></div>
		</div>
	</div>
	
	<!-- Include custom Socket.IO functionality and event handlers -->
	<script type='text/ecmascript' src='js/socket.js'></script>

	<script>
		var colors = {		/** Color presets for customization, AU colors! */
			primaryBlue: '#03244d',
			primaryOrange: '#dd550c',
			secondaryBlue: '#496e9c',
			secondaryOrange: '#f68026'
		};
		
		/** Precalculate width of KineticJS stage based on container width */
		var containerWidth = $('#container').css('width');
		containerWidth = containerWidth.substring(0, containerWidth.length - 2);
		containerWidth = parseInt(containerWidth);
		
		/** Create KineticJS Stage and calculate its center point to offset from */
		var stage = new Kinetic.Stage({
			container: 'container',
			width: containerWidth,
			height: 250
		});
		var stageCenter = {
			x: stage.getWidth() / 2,
			y: stage.getHeight() / 2
		};
		
		/** Create all needed KineticJS layers */
		var splashLayer = new Kinetic.Layer();
		var activeLayer = new Kinetic.Layer();
		
		/** Create Title and Description text objects, these will
			be on their own layer because they only need to be drawn
			once. */
		var titleText = new Kinetic.Text({
			x: stageCenter.x, y: 20,
			fill: colors.primaryOrange, stroke: colors.primaryBlue,
			fontFamily: 'Impact', fontStyle: 'bold', fontSize: 48,
			shadowColor: 'black', shadowBlur: 10, shadowOffset: [0,7],
			shadowOpacity: 0.2, strokeWidth: 4, text: 'Get24'
		});
		titleText.setX(titleText.getX() - titleText.getWidth() / 2);
	
		var descText = new Kinetic.Text({
			x: stageCenter.x, y: 80,
			fill: colors.primaryBlue, fontFamily: 'Impact', fontSize: 16,
			text: 'The competitive real-time multiplayer math game'
		});
		descText.setX(descText.getX() - descText.getWidth() / 2);
	
		splashLayer.add(titleText);
		splashLayer.add(descText);
		stage.add(splashLayer);

		/** Create text objects to hold each of our card digits */
		var cardText = [];
		var cardTextVisible = false;
		for(var i = 0; i < 4; i++) {
			cardText[i] = new Kinetic.Text({
				x:-150, y:130, fontFamily: 'Impact', fontStyle: 'bold', 
				fontSize: 48, shadowColor: 'black', shadowOffset: [0,7],
				shadowOpacity: 0.2, fill: colors.primaryOrange, text: '0',
				stroke: colors.primaryBlue, strokeWidth: 4, visible: false
			});
			activeLayer.add(cardText[i]);
		}
		function initializeCardText(card) {
				animateCardText(card);
				$('#evalInput').prop('disabled', false);
				$('#submitButton').removeClass('disabled');
				playersText.setVisible(true);
				timerText.setVisible(true);
		}
		function animateCardText(cardVector) {
			for (var i = 0; i < cardText.length; i++) {
				cardText[i].setVisible(true);
				cardText[i].setText(cardVector[i]);
				cardText[i].transitionTo({
					x: stageCenter.x - 86 + (i*50), easing: 'ease-in', duration: 1.5
				});
			}
			cardTextVisible = true;
		}
		function fadeCardText(callback) {
			for (var i = 0; i < cardText.length; i++) {
				if (i < cardText.length - 1) {
					cardText[i].transitionTo({ 
						opacity: 0, duration: 1
					});
				} else {
					cardText[i].transitionTo({ 
						opacity: 0, duration: 1, callback: callback
					});
				}
			}
		}
		function resetCardText() {
			for (var i = 0; i < cardText.length; i++) {
				cardText[i].setVisible(false);
				cardText[i].setOpacity(1);
				cardText[i].setX(-150);
				activeLayer.draw();
			}
			cardTextVisible = false;
		}
		
		/** Play button and help button, along with their events */
		var playButton = new Kinetic.Group({
			x: stageCenter.x - 65, 
			y: stageCenter.y + 40
		});
		var playButtonRect = new Kinetic.Rect({
			x: -50, y: -20, width: 100, height: 40,
			fill: colors.primaryOrange, stroke: colors.primaryBlue,
			strokeWidth: 4, cornerRadius: 10
		});
		var playButtonText = new Kinetic.Text({
			x: -51, y: -10, width: 100, height: 40, align: 'center',
			fill: colors.primaryBlue, fontFamily: 'Impact',
			fontSize: 20, text: 'PLAY'
		});
		
		playButton.on('mouseover', onMouseOverKineticButton);
		playButton.on('mouseout', onMouseOutKineticButton);
		playButton.on('click tap', connectSocket);
	
		playButton.add(playButtonRect);
		playButton.add(playButtonText);
		activeLayer.add(playButton);

		var helpButton = new Kinetic.Group({
			x: stageCenter.x + 65,
			y: stageCenter.y + 40
		});
		var helpButtonRect = new Kinetic.Rect({
			x: -50, y: -20, width: 100, height:40, fill: colors.primaryOrange,
			stroke: colors.primaryBlue,	strokeWidth: 4, cornerRadius: 10
		});
		var helpButtonText = new Kinetic.Text({
			x: -51, y: -10, width: 100, height: 40, fill: colors.primaryBlue,
			fontFamily: 'Impact', fontSize: 20, align: 'center', text: 'HELP'
		});
		
		helpButton.add(helpButtonRect);
		helpButton.add(helpButtonText);
		
		helpButton.on('mouseover', onMouseOverKineticButton);
		helpButton.on('mouseout', onMouseOutKineticButton);
		helpButton.on('click tap', function () {
			activeLayer.add(helpDialog);
			activeLayer.draw();
		});
		activeLayer.add(helpButton);

		/** Pop-up help dialog */
		var helpDialog = new Kinetic.Group({
			x:10, y:10
		});
		var helpDialogRect = new Kinetic.Rect({
			x:0, y:0, width: stage.getWidth() - 25, 
			height: stage.getHeight() - 40, fill: colors.primaryOrange, 
			stroke: colors.primaryBlue, strokeWidth: 4, cornerRadius: 10
		});
		
		var helpDialogCenter = { 
			x: helpDialogRect.getWidth() / 2,
			y: helpDialogRect.getHeight() / 2 
		}
		
		var helpMessage = 'How to Play\n\nThe object of Get24 is to create ' +
			'a arithmetical expression, using the four digits shown and some' +
			' combination of the four basic arithmetical operators, which ' +
			'will evaluate to 24. The first player to do so wins.\n\n' +
			'Each of the four digits given must be used exactly once. ' +
			'Legal operators are  + - * / ()'; 
		var helpDialogText = new Kinetic.Text({
			x: 0, y:0, align: 'center', padding: 10, text: helpMessage,
			height: stage.getHeight() - 40, width: stage.getWidth() - 25,
			fill: colors.primaryBlue, fontFamily: 'Impact', fontSize: 16,
		});
		
		helpDialog.add(helpDialogRect);
		helpDialog.add(helpDialogText);		
		
		helpDialog.on('click tap', function () {
			helpDialog.remove();
			activeLayer.draw();
		});

		/** Main center message text */
		var mainMsg = new Kinetic.Text({
			x: stageCenter.x, y: 140, fill: colors.primaryOrange, 
			stroke: colors.primaryBlue, fontFamily: 'Impact', fontStyle: 'bold', 
			fontSize: 36, shadowColor: 'black', shadowBlur: 10, strokeWidth: 3,
			shadowOffset: [0,7], shadowOpacity: 0.2, opacity: 0
		});
		var mainMsgAnim = new Kinetic.Animation(function (frame) {
			mainMsg.setOpacity(Math.abs(Math.sin(frame.time / 1000)));
			activeLayer.draw();
		}, activeLayer);
		function showMainMessage(msg) {
			mainMsg.setText(msg);
			mainMsg.setX(stageCenter.x - mainMsg.getWidth() / 2);
			mainMsgAnim.start();
		}
		function stopMainMessage(callback) {
			mainMsgAnim.stop();
			mainMsg.transitionTo({
				opacity: 0, duration: 1, callback: callback
			});
		}
		activeLayer.add(mainMsg);
		
		/** Number of players, and timer labels */
		var playersText = new Kinetic.Text({
			x: stageCenter.x - 160, y: 220, fill: colors.primaryBlue, fontFamily: 'Impact', 
			fontSize: 20, text: 'Players: ', visible: false
		});
		activeLayer.add(playersText);
		
		var timerText = new Kinetic.Text({
			x: stageCenter.x + 74, y: 220, fill: colors.primaryBlue, fontFamily: 'Impact',
			fontSize: 20, text: 'Timer:', visible: false
		});
		activeLayer.add(timerText);
		
		/** Evaluated expression label */
		var evaluatedText = new Kinetic.Text({
			x: stageCenter.x, y: 222, fontFamily: 'Impact', 
			fontSize: 14, visible: false
		});		
		function showEvaluatedText(txt, fill, blink, time) {
			evaluatedText.setText(txt);
			evaluatedText.setFill(fill);
			evaluatedText.setX(stageCenter.x - evaluatedText.getWidth() / 2);
			evaluatedText.setVisible(true);
			activeLayer.draw();
			
			var blinkInterval = undefined;
			var willBlink = blink || true;
			
			setTimeout(function () {
				if (willBlink) clearInterval(blinkInterval);
				evaluatedText.setVisible(false);
				evaluatedText.setText('');
				activeLayer.draw();
			}, time || 2000);
			if (willBlink) blinkInterval = setInterval(function () {
				evaluatedText.setVisible(!evaluatedText.getVisible());
				activeLayer.draw();
			}, 300);
		}
		activeLayer.add(evaluatedText);
		
		stage.add(activeLayer);
				
		function onMouseOverKineticButton() {
			this.children[0].setFill(colors.secondaryOrange);
			document.body.style.cursor = 'pointer';
			activeLayer.draw();
		}
	
		function onMouseOutKineticButton() {
			this.children[0].setFill(colors.primaryOrange);
			document.body.style.cursor = 'auto';
			activeLayer.draw();
		}
		
		/** Attach jQuery events */
		$('#evalInput').focus(function () {
			var boxShadow = 'inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(3,36,77,.6)';
			$('#submitButton').css('-moz-box-shadow', boxShadow);
			$('#submitButton').css('-webkit-box-shadow', boxShadow);
			$('#submitButton').css('box-shadow', boxShadow);
		});
		$('#evalInput').focusout(function () {
			$('#submitButton').css('-moz-box-shadow', 'none');
			$('#submitButton').css('-webkit-box-shadow', 'none');
			$('#submitButton').css('box-shadow', 'none');
		});
		$('#evalInput').on('keydown', function (e) {
			var code = e.keyCode ? e.keyCode : e.which;
			if (code == 13) {
				socket.emit('submitExpression', { expression: $('#evalInput').val() });
				$('#evalInput').val('');
			}
		});
		$('#submitButton').on('vclick', function () {
			socket.emit('submitExpression', { expression: $('#evalInput').val() });
			$('#evalInput').val('');
		});
		
	</script>
</body>
</html>
